{"ast":null,"code":"\"use strict\";\n\nvar _asyncToGenerator = require(\"C:/Users/cabra/PROJETOS/CIM/RDA/node_modules/@babel/runtime/helpers/asyncToGenerator\").default;\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CacheInterceptor = void 0;\n\nconst tslib_1 = require(\"tslib\");\n\nconst rxjs_1 = require(\"rxjs\");\n\nconst operators_1 = require(\"rxjs/operators\");\n\nconst decorators_1 = require(\"../../decorators\");\n\nconst shared_utils_1 = require(\"../../utils/shared.utils\");\n\nconst cache_constants_1 = require(\"../cache.constants\");\n\nconst HTTP_ADAPTER_HOST = 'HttpAdapterHost';\nconst REFLECTOR = 'Reflector';\nlet CacheInterceptor = class CacheInterceptor {\n  constructor(cacheManager, reflector) {\n    this.cacheManager = cacheManager;\n    this.reflector = reflector;\n    this.allowedMethods = ['GET'];\n  }\n\n  intercept(context, next) {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      var _a;\n\n      const key = _this.trackBy(context);\n\n      const ttlValueOrFactory = (_a = _this.reflector.get(cache_constants_1.CACHE_TTL_METADATA, context.getHandler())) !== null && _a !== void 0 ? _a : null;\n\n      if (!key) {\n        return next.handle();\n      }\n\n      try {\n        const value = yield _this.cacheManager.get(key);\n\n        if (!shared_utils_1.isNil(value)) {\n          return rxjs_1.of(value);\n        }\n\n        const ttl = shared_utils_1.isFunction(ttlValueOrFactory) ? yield ttlValueOrFactory(context) : ttlValueOrFactory;\n        return next.handle().pipe(operators_1.tap(response => {\n          const args = shared_utils_1.isNil(ttl) ? [key, response] : [key, response, {\n            ttl\n          }];\n\n          _this.cacheManager.set(...args);\n        }));\n      } catch (_b) {\n        return next.handle();\n      }\n    })();\n  }\n\n  trackBy(context) {\n    const httpAdapter = this.httpAdapterHost.httpAdapter;\n    const isHttpApp = httpAdapter && !!httpAdapter.getRequestMethod;\n    const cacheMetadata = this.reflector.get(cache_constants_1.CACHE_KEY_METADATA, context.getHandler());\n\n    if (!isHttpApp || cacheMetadata) {\n      return cacheMetadata;\n    }\n\n    const request = context.getArgByIndex(0);\n\n    if (!this.isRequestCacheable(context)) {\n      return undefined;\n    }\n\n    return httpAdapter.getRequestUrl(request);\n  }\n\n  isRequestCacheable(context) {\n    const req = context.switchToHttp().getRequest();\n    return this.allowedMethods.includes(req.method);\n  }\n\n};\n\ntslib_1.__decorate([decorators_1.Optional(), decorators_1.Inject(HTTP_ADAPTER_HOST), tslib_1.__metadata(\"design:type\", Object)], CacheInterceptor.prototype, \"httpAdapterHost\", void 0);\n\nCacheInterceptor = tslib_1.__decorate([decorators_1.Injectable(), tslib_1.__param(0, decorators_1.Inject(cache_constants_1.CACHE_MANAGER)), tslib_1.__param(1, decorators_1.Inject(REFLECTOR)), tslib_1.__metadata(\"design:paramtypes\", [Object, Object])], CacheInterceptor);\nexports.CacheInterceptor = CacheInterceptor;","map":{"version":3,"sources":["C:/Users/cabra/PROJETOS/CIM/BACKEND/node_modules/@nestjs/common/cache/interceptors/cache.interceptor.js"],"names":["Object","defineProperty","exports","value","CacheInterceptor","tslib_1","require","rxjs_1","operators_1","decorators_1","shared_utils_1","cache_constants_1","HTTP_ADAPTER_HOST","REFLECTOR","constructor","cacheManager","reflector","allowedMethods","intercept","context","next","_a","key","trackBy","ttlValueOrFactory","get","CACHE_TTL_METADATA","getHandler","handle","isNil","of","ttl","isFunction","pipe","tap","response","args","set","_b","httpAdapter","httpAdapterHost","isHttpApp","getRequestMethod","cacheMetadata","CACHE_KEY_METADATA","request","getArgByIndex","isRequestCacheable","undefined","getRequestUrl","req","switchToHttp","getRequest","includes","method","__decorate","Optional","Inject","__metadata","prototype","Injectable","__param","CACHE_MANAGER"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.CacheInterceptor = void 0;\nconst tslib_1 = require(\"tslib\");\nconst rxjs_1 = require(\"rxjs\");\nconst operators_1 = require(\"rxjs/operators\");\nconst decorators_1 = require(\"../../decorators\");\nconst shared_utils_1 = require(\"../../utils/shared.utils\");\nconst cache_constants_1 = require(\"../cache.constants\");\nconst HTTP_ADAPTER_HOST = 'HttpAdapterHost';\nconst REFLECTOR = 'Reflector';\nlet CacheInterceptor = class CacheInterceptor {\n    constructor(cacheManager, reflector) {\n        this.cacheManager = cacheManager;\n        this.reflector = reflector;\n        this.allowedMethods = ['GET'];\n    }\n    async intercept(context, next) {\n        var _a;\n        const key = this.trackBy(context);\n        const ttlValueOrFactory = (_a = this.reflector.get(cache_constants_1.CACHE_TTL_METADATA, context.getHandler())) !== null && _a !== void 0 ? _a : null;\n        if (!key) {\n            return next.handle();\n        }\n        try {\n            const value = await this.cacheManager.get(key);\n            if (!shared_utils_1.isNil(value)) {\n                return rxjs_1.of(value);\n            }\n            const ttl = shared_utils_1.isFunction(ttlValueOrFactory)\n                ? await ttlValueOrFactory(context)\n                : ttlValueOrFactory;\n            return next.handle().pipe(operators_1.tap(response => {\n                const args = shared_utils_1.isNil(ttl) ? [key, response] : [key, response, { ttl }];\n                this.cacheManager.set(...args);\n            }));\n        }\n        catch (_b) {\n            return next.handle();\n        }\n    }\n    trackBy(context) {\n        const httpAdapter = this.httpAdapterHost.httpAdapter;\n        const isHttpApp = httpAdapter && !!httpAdapter.getRequestMethod;\n        const cacheMetadata = this.reflector.get(cache_constants_1.CACHE_KEY_METADATA, context.getHandler());\n        if (!isHttpApp || cacheMetadata) {\n            return cacheMetadata;\n        }\n        const request = context.getArgByIndex(0);\n        if (!this.isRequestCacheable(context)) {\n            return undefined;\n        }\n        return httpAdapter.getRequestUrl(request);\n    }\n    isRequestCacheable(context) {\n        const req = context.switchToHttp().getRequest();\n        return this.allowedMethods.includes(req.method);\n    }\n};\ntslib_1.__decorate([\n    decorators_1.Optional(),\n    decorators_1.Inject(HTTP_ADAPTER_HOST),\n    tslib_1.__metadata(\"design:type\", Object)\n], CacheInterceptor.prototype, \"httpAdapterHost\", void 0);\nCacheInterceptor = tslib_1.__decorate([\n    decorators_1.Injectable(),\n    tslib_1.__param(0, decorators_1.Inject(cache_constants_1.CACHE_MANAGER)),\n    tslib_1.__param(1, decorators_1.Inject(REFLECTOR)),\n    tslib_1.__metadata(\"design:paramtypes\", [Object, Object])\n], CacheInterceptor);\nexports.CacheInterceptor = CacheInterceptor;\n"]},"metadata":{},"sourceType":"script"}